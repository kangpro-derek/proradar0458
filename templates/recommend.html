<!DOCTYPE html>

{% extends 'base.html' %}

{% block content %}


<body class="container py-4">
 

<!-- âœ… í˜ì´ì§€ íƒ€ì´í‹€ -->
<div class="mb-4 text-center">
  <h3 class="fw-bold text-light">ğŸ¯ ì§€ê¸ˆ ì‹œì‘í•˜ê¸°ì— ì í•©í•œ ì „ëµì„ ì¶”ì²œ ë°›ìœ¼ì„¸ìš”!</h3>
  <p class="text-muted small mb-1">ê³¼ê±° ìœ ì‚¬ êµ¬ê°„ì˜ ì„±ê³¼ë¥¼ ì¶”ì í•˜ì—¬ ìµœì ì˜ ì „ëµì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>
  <p class="text-warning small">[ì£¼ì˜] ì¶”ì²œì „ëµì´ ê³¼ê±°ì™€ ìœ ì‚¬í•œ ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.</p>
</div>


  
  <form method="post" class="mb-4">
    <div class="row g-2 align-items-end">
  
     <!-- ê¸°ì¤€ ì„ íƒ -->
    <div class="col-md-3">
      <label class="form-label">ê¸°ì¤€ ì„ íƒ</label>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="date_mode" id="today_mode" value="today"
              {% if date_mode == 'today' or not date_mode %}checked{% endif %}>
        <label class="form-check-label" for="today_mode">ì˜¤ëŠ˜ ê¸°ì¤€</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="date_mode" id="custom_mode" value="custom"
              {% if date_mode == 'custom' %}checked{% endif %}>
        <label class="form-check-label" for="custom_mode">íŠ¹ì •ì¼ ê¸°ì¤€</label>
      </div>
    </div>

    <!-- ë‚ ì§œ ì…ë ¥ -->
    <div class="col-md-3">
      <label class="form-label">ê¸°ì¤€ ë‚ ì§œ</label>
      <input type="date" class="form-control" name="custom_date" id="custom_date"
            value="{{ selected_date or '' }}"
            {% if date_mode != 'custom' %}disabled{% endif %}>
    </div>


  
      <!-- ì‹¤í–‰ ë²„íŠ¼ (ì¶”ì²œ í˜ì´ì§€ìš©) -->
      <div class="col-md-3">
        <div id="recommend-btn-group">
          <button id="recommend-btn" type="submit" class="btn btn-success w-100">ğŸ“Š ì „ëµ ì¶”ì²œ ì‹¤í–‰</button>
          <div id="recommend-spinner" class="text-center mt-1" style="display: none;">
            <div class="spinner-border text-light" role="status" style="width: 1.5rem; height: 1.5rem;"></div>
            <div class="small">ì¶”ì²œ ì¤‘...</div>
          </div>
        </div>
      </div>
  
    </div>
  </form>
      

  {% if recommend_result %}
<div class="mt-5">

  <!-- âœ… 1. ë¶„ì„ êµ¬ê°„ ë°ì´í„° -->
  {% if recommend_result %}
<!-- âœ… ë¶„ì„ ê²°ê³¼ ì˜ì—­ -->
<div class="p-3 rounded recommend-output" style="background-color: #2c2f33;">
  <div class="text-light mb-2">
    <div class="mb-1">
      ğŸ“Œ <strong style="font-size: 1.25rem;">
        ì¶”ì²œ ê¸°ì¤€ì¼: {{ recommend_result["ê¸°ì¤€ì¼"] }}
      </strong>
    </div>
    <div class="mt-1 small">
      âœ… <strong>ë¶„ì„ êµ¬ê°„:</strong> {{ recommend_result["ì‹œì‘ì¼"] }} ~ {{ recommend_result["ì¢…ë£Œì¼"] }}
    </div>
  </div>



  <!-- âœ… ë¶„ì„ ì°¨íŠ¸ -->
  {% if chart_html %}
    <div class="mb-3">{{ chart_html|safe }}</div>
  {% endif %}

  <!-- âœ… ì§€í‘œ ì¹´ë“œ -->
  <div class="row row-cols-2 row-cols-md-6 g-2 mt-2">
    <div class="col">
      <div class="analysis-card">
        ì •ë°°ì—´(20ma-60ma)
        <strong>{{ recommend_result["ì •ë°°ì—´"] }}</strong>
      </div>
    </div>
    <div class="col">
      <div class="analysis-card">
        ê¸°ìš¸ê¸°(20ma 10ì¼)
        <strong>{{ recommend_result["ê¸°ìš¸ê¸°"] }}</strong>
      </div>
    </div>
    <div class="col">
      <div class="analysis-card">
        ì´ê²©ë„(ì£¼ê°€/20ma)
        <strong>{{ recommend_result["ì´ê²©ë„"] }}</strong>
      </div>
    </div>
    <div class="col">
      <div class="analysis-card">
        RSI(14)
        <strong>{{ recommend_result["RSI"] }}</strong>
      </div>
    </div>
    <div class="col">
      <div class="analysis-card">
        ROC(12)
        <strong>{{ recommend_result["ROC"] }}</strong>
      </div>
    </div>
    <div class="col">
      <div class="analysis-card">
        ë³€ë™ì„±(20day)
        <strong>{{ recommend_result["ë³€ë™ì„±"] }}</strong>
      </div>      
    </div>
  </div>
</div>
{% endif %}




<div class="mt-5 recommend-output"> <!-- âœ… ìœ ì‚¬ êµ¬ê°„ Top 3 ìƒì„¸ ì¶œë ¥ -->
  <h5 class="mt-5">ğŸ“Œ ìœ ì‚¬í–ˆë˜ ê³¼ê±° êµ¬ê°„ (Top 3)</h5>
  <div class="row row-cols-1 row-cols-md-3 g-3">
    {% for item in recommend_result['ìœ ì‚¬êµ¬ê°„ìƒì„¸'] %}
      <div class="col">
        <div class="card h-100 text-dark bg-light">
          <div class="card-header fw-bold">
            {{ item.ì‹œì‘ì¼.strftime("%Y-%m-%d") }} ~ {{ item.ì¢…ë£Œì¼.strftime("%Y-%m-%d") }}
          </div>
          <div class="card-body">
            <div class="mb-2 small text-dark">
              ğŸ“… ì„±ê³¼ í™•ì¸ ê¸°ê°„: {{ item.ì„±ê³¼ì‹œì‘ }} ~ {{ item.ì„±ê³¼ì¢…ë£Œ }}<br>
              ğŸ¯ ìœ ì‚¬ë„: 
              <span style="color: {% if item.ìœ ì‚¬ë„.replace('%', '')|float < 70 %}red{% else %}inherit{% endif %};">
                {{ item.ìœ ì‚¬ë„ }}
              </span>
            </div>
            
            
  
            <!-- âœ… ìœ ì‚¬ êµ¬ê°„ ì°¨íŠ¸ ì¶œë ¥ -->
            {% if item.ì°¨íŠ¸ %}
            <div class="mt-2">{{ item.ì°¨íŠ¸|safe }}</div>
            {% endif %}

            <!-- âœ… ì§€í‘œ ì¹´ë“œ (6ê°œ) -->
            <div class="row row-cols-3 g-2 text-center mt-2">
              <div class="col"><div class="border rounded p-1 bg-white bg-opacity-75 small">ì •ë°°ì—´<br><strong>{{ item.ì •ë°°ì—´ }}</strong></div></div>
              <div class="col"><div class="border rounded p-1 bg-white bg-opacity-75 small">ê¸°ìš¸ê¸°<br><strong>{{ item.ê¸°ìš¸ê¸° }}</strong></div></div>
              <div class="col"><div class="border rounded p-1 bg-white bg-opacity-75 small">ì´ê²©ë„<br><strong>{{ item.ì´ê²©ë„ }}</strong></div></div>
              <div class="col"><div class="border rounded p-1 bg-white bg-opacity-75 small">RSI<br><strong>{{ item.RSI }}</strong></div></div>              
              <div class="col"><div class="border rounded p-1 bg-white bg-opacity-75 small">ROC<br><strong>{{ item.ROC }}</strong></div></div>
              <div class="col"><div class="border rounded p-1 bg-white bg-opacity-75 small">ë³€ë™ì„±<br><strong>{{ item.ë³€ë™ì„± }}</strong></div></div>
            </div>
  
            <hr class="my-3">

            <!-- âœ… ì „ëµë³„ ì„±ê³¼ -->
            <div class="small">
              <p>ğŸ“ˆ <strong>Pro1</strong>: ìˆ˜ìµë¥  {{ item.Pro1.ìˆ˜ìµë¥  }}, MDD {{ item.Pro1.MDD }}</p>
              <p>ğŸ“ˆ <strong>Pro2</strong>: ìˆ˜ìµë¥  {{ item.Pro2.ìˆ˜ìµë¥  }}, MDD {{ item.Pro2.MDD }}</p>
              <p>ğŸ“ˆ <strong>Pro3</strong>: ìˆ˜ìµë¥  {{ item.Pro3.ìˆ˜ìµë¥  }}, MDD {{ item.Pro3.MDD }}</p>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  

  <div class="mt-4 mx-auto recommend-output" style="max-width: 360px;"> <!-- ì „ëµë³„ ì ìˆ˜ -->
<!-- âœ… ì „ëµë³„ ì ìˆ˜ (ê³ ì • í­ + ê°€ìš´ë° ì •ë ¬) -->
<div class="mt-4 mx-auto" style="max-width: 360px;">  <!-- ì•½ 1/3í­ + ê°€ìš´ë° ì •ë ¬ -->
  <div class="p-3 rounded bg-light text-dark">
    <h5>ğŸ“Š ì „ëµë³„ ì¢…í•© ì ìˆ˜</h5>
    <div class="d-flex flex-column gap-2 mt-2">
      {% for strat, score in recommend_result["ì ìˆ˜"].items() %}
        <div class="border rounded p-2 bg-white bg-opacity-75 d-flex justify-content-between align-items-center">
          <span class="fw-bold">ğŸ“ˆ{{ strat }}</span>
          <span class="fs-6">{{ "%.2f"|format(score) }}</span>
        </div>
      {% endfor %}
    </div>
  </div>
</div>



<!-- âœ… 4. ìµœì¢… ì¶”ì²œ ì „ëµ (ê°€ë¡œí­ ê³ ì • + ì¤‘ì•™ ì •ë ¬ + ìœ„ê°„ê²© ì¶”ê°€) -->
<div class="mt-4 mx-auto recommend-output" style="max-width: 360px;"> <!-- ìµœì¢… ì¶”ì²œ ì „ëµ -->
  <div class="alert alert-success text-center">

    <!-- ğŸ†• ê¸°ì¤€ì¼ ë‚ ì§œë§Œ í‘œì‹œ -->
    <div class="mb-2 text-dark">{{ recommend_result["ê¸°ì¤€ì¼"] }}</div>

    <strong class="fs-3">ğŸ¯ì¶”ì²œ ì „ëµ:</strong> <span class="fs-2">{{ recommend_result["ì¶”ì²œ"] }}</span>

    {% if recommend_result["ì¶”ì²œì „ëµíŒŒë¼ë¯¸í„°"] %}
    <div class="mt-3 small text-dark">
      <div><strong>ë¶„í•  ë¹„ìœ¨:</strong> {{ recommend_result["ì¶”ì²œì „ëµíŒŒë¼ë¯¸í„°"]["weights"] }}</div>
      
      <!-- âœ… ì—¬ê¸°ì— 3ì—´ ì¹´ë“œ ì‚½ì… -->
      <div class="row row-cols-3 g-2 mt-2">
        {% for tag in recommend_result["ì¶”ì²œì „ëµíŒŒë¼ë¯¸í„°"]["details"] %}
          <div class="col">
            <div class="border rounded bg-light text-dark text-center small px-2 py-1">
              {{ tag }}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>



  


</div>
{% endif %}


  <div>

  </div>
</body>
</html>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const todayRadio = document.getElementById("today_mode");
    const customRadio = document.getElementById("custom_mode");
    const dateInput = document.getElementById("custom_date");

    function toggleDateInput() {
      if (customRadio.checked) {
        dateInput.disabled = false;
      } else {
        const today = new Date().toISOString().split('T')[0];  // ì˜¤ëŠ˜ ë‚ ì§œ yyyy-mm-dd
        dateInput.value = today;
        dateInput.disabled = true;
      }
    }

    todayRadio.addEventListener("change", toggleDateInput);
    customRadio.addEventListener("change", toggleDateInput);

    toggleDateInput();  // ìµœì´ˆ ë¡œë”© ì‹œ ì´ˆê¸°í™”
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");
    const recommendBtn = document.getElementById("recommend-btn");
    const recommendSpinner = document.getElementById("recommend-spinner");

    // âœ… ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ì´ì „ ì…ë ¥ê°’
    const lastDateMode = "{{ 'today' if selected_date == today else 'custom' }}";
    const lastCustomDate = "{{ selected_date }}";
    const hasResults = {{ 'true' if recommend_result else 'false' }};

    form.addEventListener("submit", function (event) {
      const selectedMode = form.querySelector("input[name='date_mode']:checked").value;
      const selectedDate = form.querySelector("input[name='custom_date']").value;

      // âœ… ê²°ê³¼ê°€ ìˆê³ , ì´ì „ê³¼ ë™ì¼í•œ ì…ë ¥ì´ë©´ ì‹¤í–‰ ë§‰ê¸°
      if (
        hasResults &&
        selectedMode === lastDateMode &&
        (selectedMode === "today" || selectedDate === lastCustomDate)
      ) {
        event.preventDefault();
        alert("âš ï¸ ì´ì „ê³¼ ë™ì¼í•œ ê¸°ì¤€ì…ë‹ˆë‹¤.");
        return;
      }

      // âœ… ë²„íŠ¼ ìˆ¨ê¸°ê³  ë¡œë”© í‘œì‹œ
      if (recommendBtn) recommendBtn.style.display = "none";
      if (recommendSpinner) recommendSpinner.style.display = "block";

      // âœ… ê²°ê³¼ íë¦¬ê²Œ í‘œì‹œ
      const resultSections = document.querySelectorAll(".recommend-output");
      resultSections.forEach(el => el.style.opacity = "0.3");
    });
  });
</script>


  
{% endblock %}