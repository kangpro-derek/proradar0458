<!DOCTYPE html>

{% extends 'base.html' %}

{% block content %}


<body class="container py-4">
 

<!-- ✅ 페이지 타이틀 -->
<div class="mb-4 text-center">
  <h3 class="fw-bold text-light">🎯 지금 시작하기에 적합한 전략을 추천 받으세요!</h3>
  <p class="text-muted small mb-1">과거 유사 구간의 성과를 추적하여 최적의 전략을 추천합니다.</p>
  <p class="text-warning small">[주의] 추천전략이 과거와 유사한 수익을 보장하지는 않습니다.</p>
</div>


  
  <form method="post" class="mb-4">
    <div class="row g-2 align-items-end">
  
     <!-- 기준 선택 -->
    <div class="col-md-3">
      <label class="form-label">기준 선택</label>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="date_mode" id="today_mode" value="today"
              {% if date_mode == 'today' or not date_mode %}checked{% endif %}>
        <label class="form-check-label" for="today_mode">오늘 기준</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="date_mode" id="custom_mode" value="custom"
              {% if date_mode == 'custom' %}checked{% endif %}>
        <label class="form-check-label" for="custom_mode">특정일 기준</label>
      </div>
    </div>

    <!-- 날짜 입력 -->
    <div class="col-md-3">
      <label class="form-label">기준 날짜</label>
      <input type="date" class="form-control" name="custom_date" id="custom_date"
            value="{{ selected_date or '' }}"
            {% if date_mode != 'custom' %}disabled{% endif %}>
    </div>


  
      <!-- 실행 버튼 (추천 페이지용) -->
      <div class="col-md-3">
        <div id="recommend-btn-group">
          <button id="recommend-btn" type="submit" class="btn btn-success w-100">📊 전략 추천 실행</button>
          <div id="recommend-spinner" class="text-center mt-1" style="display: none;">
            <div class="spinner-border text-light" role="status" style="width: 1.5rem; height: 1.5rem;"></div>
            <div class="small">추천 중...</div>
          </div>
        </div>
      </div>
  
    </div>
  </form>
      

  {% if recommend_result %}
<div class="mt-5">

  <!-- ✅ 1. 분석 구간 데이터 -->
  {% if recommend_result %}
<!-- ✅ 분석 결과 영역 -->
<div class="p-3 rounded recommend-output" style="background-color: #2c2f33;">
  <div class="text-light mb-2">
    <div class="mb-1">
      📌 <strong style="font-size: 1.25rem;">
        추천 기준일: {{ recommend_result["기준일"] }}
      </strong>
    </div>
    <div class="mt-1 small">
      ✅ <strong>분석 구간:</strong> {{ recommend_result["시작일"] }} ~ {{ recommend_result["종료일"] }}
    </div>
  </div>



  <!-- ✅ 분석 차트 -->
  {% if chart_html %}
    <div class="mb-3">{{ chart_html|safe }}</div>
  {% endif %}

  <!-- ✅ 지표 카드 -->
  <div class="row row-cols-2 row-cols-md-6 g-2 mt-2">
    <div class="col">
      <div class="analysis-card">
        정배열(20ma-60ma)
        <strong>{{ recommend_result["정배열"] }}</strong>
      </div>
    </div>
    <div class="col">
      <div class="analysis-card">
        기울기(20ma 10일)
        <strong>{{ recommend_result["기울기"] }}</strong>
      </div>
    </div>
    <div class="col">
      <div class="analysis-card">
        이격도(주가/20ma)
        <strong>{{ recommend_result["이격도"] }}</strong>
      </div>
    </div>
    <div class="col">
      <div class="analysis-card">
        RSI(14)
        <strong>{{ recommend_result["RSI"] }}</strong>
      </div>
    </div>
    <div class="col">
      <div class="analysis-card">
        ROC(12)
        <strong>{{ recommend_result["ROC"] }}</strong>
      </div>
    </div>
    <div class="col">
      <div class="analysis-card">
        변동성(20day)
        <strong>{{ recommend_result["변동성"] }}</strong>
      </div>      
    </div>
  </div>
</div>
{% endif %}




<div class="mt-5 recommend-output"> <!-- ✅ 유사 구간 Top 3 상세 출력 -->
  <h5 class="mt-5">📌 유사했던 과거 구간 (Top 3)</h5>
  <div class="row row-cols-1 row-cols-md-3 g-3">
    {% for item in recommend_result['유사구간상세'] %}
      <div class="col">
        <div class="card h-100 text-dark bg-light">
          <div class="card-header fw-bold">
            {{ item.시작일.strftime("%Y-%m-%d") }} ~ {{ item.종료일.strftime("%Y-%m-%d") }}
          </div>
          <div class="card-body">
            <div class="mb-2 small text-dark">
              📅 성과 확인 기간: {{ item.성과시작 }} ~ {{ item.성과종료 }}<br>
              🎯 유사도: 
              <span style="color: {% if item.유사도.replace('%', '')|float < 70 %}red{% else %}inherit{% endif %};">
                {{ item.유사도 }}
              </span>
            </div>
            
            
  
            <!-- ✅ 유사 구간 차트 출력 -->
            {% if item.차트 %}
            <div class="mt-2">{{ item.차트|safe }}</div>
            {% endif %}

            <!-- ✅ 지표 카드 (6개) -->
            <div class="row row-cols-3 g-2 text-center mt-2">
              <div class="col"><div class="border rounded p-1 bg-white bg-opacity-75 small">정배열<br><strong>{{ item.정배열 }}</strong></div></div>
              <div class="col"><div class="border rounded p-1 bg-white bg-opacity-75 small">기울기<br><strong>{{ item.기울기 }}</strong></div></div>
              <div class="col"><div class="border rounded p-1 bg-white bg-opacity-75 small">이격도<br><strong>{{ item.이격도 }}</strong></div></div>
              <div class="col"><div class="border rounded p-1 bg-white bg-opacity-75 small">RSI<br><strong>{{ item.RSI }}</strong></div></div>              
              <div class="col"><div class="border rounded p-1 bg-white bg-opacity-75 small">ROC<br><strong>{{ item.ROC }}</strong></div></div>
              <div class="col"><div class="border rounded p-1 bg-white bg-opacity-75 small">변동성<br><strong>{{ item.변동성 }}</strong></div></div>
            </div>
  
            <hr class="my-3">

            <!-- ✅ 전략별 성과 -->
            <div class="small">
              <p>📈 <strong>Pro1</strong>: 수익률 {{ item.Pro1.수익률 }}, MDD {{ item.Pro1.MDD }}</p>
              <p>📈 <strong>Pro2</strong>: 수익률 {{ item.Pro2.수익률 }}, MDD {{ item.Pro2.MDD }}</p>
              <p>📈 <strong>Pro3</strong>: 수익률 {{ item.Pro3.수익률 }}, MDD {{ item.Pro3.MDD }}</p>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  

  <div class="mt-4 mx-auto recommend-output" style="max-width: 360px;"> <!-- 전략별 점수 -->
<!-- ✅ 전략별 점수 (고정 폭 + 가운데 정렬) -->
<div class="mt-4 mx-auto" style="max-width: 360px;">  <!-- 약 1/3폭 + 가운데 정렬 -->
  <div class="p-3 rounded bg-light text-dark">
    <h5>📊 전략별 종합 점수</h5>
    <div class="d-flex flex-column gap-2 mt-2">
      {% for strat, score in recommend_result["점수"].items() %}
        <div class="border rounded p-2 bg-white bg-opacity-75 d-flex justify-content-between align-items-center">
          <span class="fw-bold">📈{{ strat }}</span>
          <span class="fs-6">{{ "%.2f"|format(score) }}</span>
        </div>
      {% endfor %}
    </div>
  </div>
</div>



<!-- ✅ 4. 최종 추천 전략 (가로폭 고정 + 중앙 정렬 + 위간격 추가) -->
<div class="mt-4 mx-auto recommend-output" style="max-width: 360px;"> <!-- 최종 추천 전략 -->
  <div class="alert alert-success text-center">

    <!-- 🆕 기준일 날짜만 표시 -->
    <div class="mb-2 text-dark">{{ recommend_result["기준일"] }}</div>

    <strong class="fs-3">🎯추천 전략:</strong> <span class="fs-2">{{ recommend_result["추천"] }}</span>

    {% if recommend_result["추천전략파라미터"] %}
    <div class="mt-3 small text-dark">
      <div><strong>분할 비율:</strong> {{ recommend_result["추천전략파라미터"]["weights"] }}</div>
      
      <!-- ✅ 여기에 3열 카드 삽입 -->
      <div class="row row-cols-3 g-2 mt-2">
        {% for tag in recommend_result["추천전략파라미터"]["details"] %}
          <div class="col">
            <div class="border rounded bg-light text-dark text-center small px-2 py-1">
              {{ tag }}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>



  


</div>
{% endif %}


  <div>

  </div>
</body>
</html>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const todayRadio = document.getElementById("today_mode");
    const customRadio = document.getElementById("custom_mode");
    const dateInput = document.getElementById("custom_date");

    function toggleDateInput() {
      if (customRadio.checked) {
        dateInput.disabled = false;
      } else {
        const today = new Date().toISOString().split('T')[0];  // 오늘 날짜 yyyy-mm-dd
        dateInput.value = today;
        dateInput.disabled = true;
      }
    }

    todayRadio.addEventListener("change", toggleDateInput);
    customRadio.addEventListener("change", toggleDateInput);

    toggleDateInput();  // 최초 로딩 시 초기화
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");
    const recommendBtn = document.getElementById("recommend-btn");
    const recommendSpinner = document.getElementById("recommend-spinner");

    // ✅ 서버에서 전달받은 이전 입력값
    const lastDateMode = "{{ 'today' if selected_date == today else 'custom' }}";
    const lastCustomDate = "{{ selected_date }}";
    const hasResults = {{ 'true' if recommend_result else 'false' }};

    form.addEventListener("submit", function (event) {
      const selectedMode = form.querySelector("input[name='date_mode']:checked").value;
      const selectedDate = form.querySelector("input[name='custom_date']").value;

      // ✅ 결과가 있고, 이전과 동일한 입력이면 실행 막기
      if (
        hasResults &&
        selectedMode === lastDateMode &&
        (selectedMode === "today" || selectedDate === lastCustomDate)
      ) {
        event.preventDefault();
        alert("⚠️ 이전과 동일한 기준입니다.");
        return;
      }

      // ✅ 버튼 숨기고 로딩 표시
      if (recommendBtn) recommendBtn.style.display = "none";
      if (recommendSpinner) recommendSpinner.style.display = "block";

      // ✅ 결과 흐리게 표시
      const resultSections = document.querySelectorAll(".recommend-output");
      resultSections.forEach(el => el.style.opacity = "0.3");
    });
  });
</script>


  
{% endblock %}