{% extends 'base.html' %}
{% block content %}
<body class="container py-4">

  <h3 class="fw-bold text-light text-center mb-4">π“ μ—°λ„λ³„ μ „λµ μ„±κ³Ό μ”μ•½</h3>
  <p class="text-muted small text-center">κ° μ „λµλ³„ μ—°κ°„ μμµλ¥ κ³Ό μµλ€ λ‚™ν­(MDD), κ·Έλ¦¬κ³  μƒμ„Έ λ°μ΄ν„°λ¥Ό ν™•μΈν•  μ μμµλ‹λ‹¤.</p>

  <div class="row row-cols-1 row-cols-md-3 g-4">

    <!-- β… Pro1 ν‘ -->
    <div class="col">
      <div class="card bg-secondary text-white h-100">
        <div class="card-body">
          <h5 class="card-title text-center fw-bold">Pro1 μ „λµ</h5>
          <table class="table table-sm table-striped text-white">
            <thead>
              <tr><th>μ—°λ„</th><th>μμµλ¥ </th><th>MDD</th><th></th></tr>
            </thead>
            <tbody>
              {% for row in pro1_stats %}
              <tr>
                <td>{{ row.μ—°λ„ }}</td>
                <td>{{ row.μμµλ¥  }}%</td>
                <td>{{ row.MDD }}%</td>
                <td><button class="btn btn-outline-light btn-sm" data-year="{{ row.μ—°λ„ }}" data-strategy="Pro1" onclick="loadChart(this)">μμ„Έν</button></td>
              </tr>
              <tr id="chart-{{ row.μ—°λ„ }}-Pro1-row" style="display: none;">
                <td colspan="4">
                  <div id="plot-{{ row.μ—°λ„ }}-Pro1" class="mt-2"></div>
                  <div class="small text-white-50 mt-2">β€» λ¶„κΈ°λ³„ μμµλ¥  μ •λ³΄λ” μ¶”ν›„ μ¶”κ°€ μμ •</div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- β… Pro2 ν‘ -->
    <div class="col">
      <div class="card bg-secondary text-white h-100">
        <div class="card-body">
          <h5 class="card-title text-center fw-bold">Pro2 μ „λµ</h5>
          <table class="table table-sm table-striped text-white">
            <thead>
              <tr><th>μ—°λ„</th><th>μμµλ¥ </th><th>MDD</th><th></th></tr>
            </thead>
            <tbody>
              {% for row in pro2_stats %}
              <tr>
                <td>{{ row.μ—°λ„ }}</td>
                <td>{{ row.μμµλ¥  }}%</td>
                <td>{{ row.MDD }}%</td>
                <td><button class="btn btn-outline-light btn-sm" data-year="{{ row.μ—°λ„ }}" data-strategy="Pro2" onclick="loadChart(this)">μμ„Έν</button></td>
              </tr>
              <tr id="chart-{{ row.μ—°λ„ }}-Pro2-row" style="display: none;">
                <td colspan="4">
                  <div id="plot-{{ row.μ—°λ„ }}-Pro2" class="mt-2"></div>
                  <div class="small text-white-50 mt-2">β€» λ¶„κΈ°λ³„ μμµλ¥  μ •λ³΄λ” μ¶”ν›„ μ¶”κ°€ μμ •</div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- β… Pro3 ν‘ -->
    <div class="col">
      <div class="card bg-secondary text-white h-100">
        <div class="card-body">
          <h5 class="card-title text-center fw-bold">Pro3 μ „λµ</h5>
          <table class="table table-sm table-striped text-white">
            <thead>
              <tr><th>μ—°λ„</th><th>μμµλ¥ </th><th>MDD</th><th></th></tr>
            </thead>
            <tbody>
              {% for row in pro3_stats %}
              <tr>
                <td>{{ row.μ—°λ„ }}</td>
                <td>{{ row.μμµλ¥  }}%</td>
                <td>{{ row.MDD }}%</td>
                <td><button class="btn btn-outline-light btn-sm" data-year="{{ row.μ—°λ„ }}" data-strategy="Pro3" onclick="loadChart(this)">μμ„Έν</button></td>
              </tr>
              <tr id="chart-{{ row.μ—°λ„ }}-Pro3-row" style="display: none;">
                <td colspan="4">
                  <div id="plot-{{ row.μ—°λ„ }}-Pro3" class="mt-2"></div>
                  <div class="small text-white-50 mt-2">β€» λ¶„κΈ°λ³„ μμµλ¥  μ •λ³΄λ” μ¶”ν›„ μ¶”κ°€ μμ •</div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- β… μ°¨νΈ λ΅λ”©μ© μ¤ν¬λ¦½νΈ -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    function loadChart(button) {
      const year = button.dataset.year;
      const strat = button.dataset.strategy;
      const row = document.getElementById(`chart-${year}-${strat}-row`);
      const plotDiv = document.getElementById(`plot-${year}-${strat}`);

      // ν† κΈ€ μ²λ¦¬
      if (row.style.display === "table-row") {
        row.style.display = "none";
        return;
      }

      row.style.display = "table-row";
      if (plotDiv.children.length > 0) return;

      fetch(`/api/stats/yearly/${year}`)
        .then(res => res.json())
        .then(data => {
          const dates = data.map(d => d.date);
          const values = data.map(d => d.portfolio_value);
          const drawdowns = data.map(d => d.drawdown);

          const fig = {
            data: [
              {
                x: dates,
                y: drawdowns,
                name: "MDD",
                yaxis: "y1",
                type: "scatter",
                fill: "tozeroy",
                line: { color: "rgba(255,100,100,0.5)" }
              },
              {
                x: dates,
                y: values,
                name: "μμ‚°",
                yaxis: "y2",
                type: "scatter",
                line: { color: "royalblue", width: 2 }
              }
            ],
            layout: {
              title: `${year}λ…„ μμ‚° λ° MDD`,
              template: "plotly_dark",
              height: 300,
              margin: { l: 30, r: 30, t: 40, b: 30 },
              yaxis: { title: "MDD", range: [-0.6, 0], side: "left" },
              yaxis2: { title: "μμ‚°", overlaying: "y", side: "right" }
            }
          };

          Plotly.newPlot(plotDiv, fig.data, fig.layout, { staticPlot: true });
        });
    }
  </script>
</body>
{% endblock %}
