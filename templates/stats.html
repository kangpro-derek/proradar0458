{% extends 'base.html' %}
{% block content %}
<body class="container py-4">

  <h3 class="fw-bold text-light text-center mb-4">📊 연도별 전략 성과 요약</h3>
  <p class="text-muted small text-center">각 전략별 연간 수익률과 최대 낙폭(MDD), 그리고 상세 데이터를 확인할 수 있습니다.</p>

  <div class="row row-cols-1 row-cols-md-3 g-4">

    <!-- ✅ Pro1 표 -->
    <div class="col">
      <div class="card bg-secondary text-white h-100">
        <div class="card-body">
          <h5 class="card-title text-center fw-bold">Pro1 전략</h5>
          <table class="table table-sm table-striped text-white">
            <thead>
              <tr><th>연도</th><th>수익률</th><th>MDD</th><th></th></tr>
            </thead>
            <tbody>
              {% for row in pro1_stats %}
              <tr>
                <td>{{ row.연도 }}</td>
                <td>{{ row.수익률 }}%</td>
                <td>{{ row.MDD }}%</td>
                <td><button class="btn btn-outline-light btn-sm" data-year="{{ row.연도 }}" data-strategy="Pro1" onclick="loadChart(this)">자세히</button></td>
              </tr>
              <tr id="chart-{{ row.연도 }}-Pro1-row" style="display: none;">
                <td colspan="4">
                  <div id="plot-{{ row.연도 }}-Pro1" class="mt-2"></div>
                  <div class="small text-white-50 mt-2">※ 분기별 수익률 정보는 추후 추가 예정</div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ✅ Pro2 표 -->
    <div class="col">
      <div class="card bg-secondary text-white h-100">
        <div class="card-body">
          <h5 class="card-title text-center fw-bold">Pro2 전략</h5>
          <table class="table table-sm table-striped text-white">
            <thead>
              <tr><th>연도</th><th>수익률</th><th>MDD</th><th></th></tr>
            </thead>
            <tbody>
              {% for row in pro2_stats %}
              <tr>
                <td>{{ row.연도 }}</td>
                <td>{{ row.수익률 }}%</td>
                <td>{{ row.MDD }}%</td>
                <td><button class="btn btn-outline-light btn-sm" data-year="{{ row.연도 }}" data-strategy="Pro2" onclick="loadChart(this)">자세히</button></td>
              </tr>
              <tr id="chart-{{ row.연도 }}-Pro2-row" style="display: none;">
                <td colspan="4">
                  <div id="plot-{{ row.연도 }}-Pro2" class="mt-2"></div>
                  <div class="small text-white-50 mt-2">※ 분기별 수익률 정보는 추후 추가 예정</div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ✅ Pro3 표 -->
    <div class="col">
      <div class="card bg-secondary text-white h-100">
        <div class="card-body">
          <h5 class="card-title text-center fw-bold">Pro3 전략</h5>
          <table class="table table-sm table-striped text-white">
            <thead>
              <tr><th>연도</th><th>수익률</th><th>MDD</th><th></th></tr>
            </thead>
            <tbody>
              {% for row in pro3_stats %}
              <tr>
                <td>{{ row.연도 }}</td>
                <td>{{ row.수익률 }}%</td>
                <td>{{ row.MDD }}%</td>
                <td><button class="btn btn-outline-light btn-sm" data-year="{{ row.연도 }}" data-strategy="Pro3" onclick="loadChart(this)">자세히</button></td>
              </tr>
              <tr id="chart-{{ row.연도 }}-Pro3-row" style="display: none;">
                <td colspan="4">
                  <div id="plot-{{ row.연도 }}-Pro3" class="mt-2"></div>
                  <div class="small text-white-50 mt-2">※ 분기별 수익률 정보는 추후 추가 예정</div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- ✅ 차트 로딩용 스크립트 -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    function loadChart(button) {
      const year = button.dataset.year;
      const strat = button.dataset.strategy;
      const row = document.getElementById(`chart-${year}-${strat}-row`);
      const plotDiv = document.getElementById(`plot-${year}-${strat}`);

      // 토글 처리
      if (row.style.display === "table-row") {
        row.style.display = "none";
        return;
      }

      row.style.display = "table-row";
      if (plotDiv.children.length > 0) return;

      fetch(`/api/stats/yearly/${year}`)
        .then(res => res.json())
        .then(data => {
          const dates = data.map(d => d.date);
          const values = data.map(d => d.portfolio_value);
          const drawdowns = data.map(d => d.drawdown);

          const fig = {
            data: [
              {
                x: dates,
                y: drawdowns,
                name: "MDD",
                yaxis: "y1",
                type: "scatter",
                fill: "tozeroy",
                line: { color: "rgba(255,100,100,0.5)" }
              },
              {
                x: dates,
                y: values,
                name: "자산",
                yaxis: "y2",
                type: "scatter",
                line: { color: "royalblue", width: 2 }
              }
            ],
            layout: {
              title: `${year}년 자산 및 MDD`,
              template: "plotly_dark",
              height: 300,
              margin: { l: 30, r: 30, t: 40, b: 30 },
              yaxis: { title: "MDD", range: [-0.6, 0], side: "left" },
              yaxis2: { title: "자산", overlaying: "y", side: "right" }
            }
          };

          Plotly.newPlot(plotDiv, fig.data, fig.layout, { staticPlot: true });
        });
    }
  </script>
</body>
{% endblock %}
